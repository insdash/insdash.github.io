---
import Button from '@/components/UI/Button.astro';

interface Props {
  measurementId: string;
  requireConsent?: boolean;
}

const { measurementId, requireConsent = true } = Astro.props;
---

<div
  id="cookie-banner"
  data-ga-id={measurementId}
  data-require-consent={requireConsent}
  class="flex flex-col justify-center items-center fixed inset-0 bg-[var(--color-caption-primary)]/80 text-[var(--color-caption-secondary)] p-4 rounded shadow-lg z-50 hidden opacity-0 transition-opacity"
>
  <p class="text-sm text-center">
    This site uses Google Analytics to understand usage. You can choose whether to allow analytics cookies.
  </p>
  <br />
  <div class="flex justify-center items-center gap-4">
    <Button id="acceptCookies" label="Accept" color="blue" variant="solid" size="md" />
    <Button id="rejectCookies" label="Reject" color="gray" variant="outline" size="md" />
  </div>
</div>

<script is:inline>
(() => {
  const banner = document.getElementById("cookie-banner");
  if (!banner) return;

  const requireConsent = banner.dataset.requireConsent === "true";
  const measurementId = banner.dataset.gaId;
  const savedConsent = localStorage.getItem("analytics_consent");

  function loadGA() {
    if (!measurementId || window.gtagLoaded) return;
    window.gtagLoaded = true;

    // Load GA via Partytown
    const script = document.createElement("script");
    script.type = "text/partytown";
    script.async = true;
    script.src = `https://www.googletagmanager.com/gtag/js?id=${measurementId}`;
    script.onload = () => {
      window.dataLayer = window.dataLayer || [];
      window.gtag = function(...args) { window.dataLayer.push(args); };

      // Initialize GA after loading
      gtag('js', new Date());
      gtag('config', measurementId, { anonymize_ip: true });
    };
    document.head.appendChild(script);
  }

  function accept() {
    localStorage.setItem("analytics_consent", "accepted");
    loadGA();
    banner?.remove();
  }

  function reject() {
    localStorage.setItem("analytics_consent", "rejected");
    banner?.remove();
  }

  if (requireConsent) {
    if (!savedConsent) {
      banner.classList.remove("hidden");
      requestAnimationFrame(() => banner.classList.add("opacity-100"));
    } else if (savedConsent === "accepted") {
      loadGA();
    }
    document.getElementById("acceptCookies")?.addEventListener("click", accept);
    document.getElementById("rejectCookies")?.addEventListener("click", reject);
  } else {
    // Auto-load GA if consent is not required
    loadGA();
  }
})();
</script>
